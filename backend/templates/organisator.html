<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Organisator Panel</title>
    <style>
        body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:2rem;max-width:860px}
        input,button,textarea{font:inherit;padding:.6rem .8rem;border:1px solid #ccc;border-radius:8px}
        form{display:grid;gap:.6rem;margin:.8rem 0}
        .row{display:flex;gap:.6rem;flex-wrap:wrap}
        .card{border:1px solid #e6e6e9;border-radius:12px;padding:1rem;margin:.6rem 0}
        .muted{color:#777}
        table{width:100%;border-collapse:collapse}
        th,td{padding:.5rem;border-bottom:1px solid #eee;text-align:left}
    </style>
</head>
<body>
<h1>Organisator Panel</h1>

<section class="card" id="auth">
    <h2>Login</h2>
    <form id="loginForm">
        <div class="row">
            <input id="username" placeholder="username" required>
            <input id="password" type="password" placeholder="password" required>
            <button type="submit">Login</button>
        </div>
    </form>
    <details>
        <summary>Sign up (dev)</summary>
        <form id="signupForm">
            <div class="row">
                <input id="s_name" placeholder="name" required>
                <input id="s_username" placeholder="username" required>
                <input id="s_password" type="password" placeholder="password" required>
                <button type="submit">Create</button>
            </div>
        </form>
    </details>
    <div id="me" class="muted"></div>
</section>

<section class="card" id="events" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">My events</h2>
        <button id="logout">Logout</button>
    </div>
    <form id="createEvent">
        <input id="e_title" placeholder="Event title" required>
        <input id="e_preview" placeholder="Preview URL (optional)">
        <div class="row">
            <input id="e_start" type="datetime-local">
            <input id="e_end" type="datetime-local">
            <input id="e_dj" type="number" placeholder="DJ id (optional)">
        </div>
        <button type="submit">Create event</button>
    </form>

    <table>
        <thead><tr><th>ID</th><th>Title</th><th>Start</th><th>End</th><th></th></tr></thead>
        <tbody id="list"></tbody>
    </table>
</section>

<script>
    const $ = (s, c=document)=>c.querySelector(s);
    const API = (p)=>p; // той самий origin

    function show(msg){ $('#me').textContent = msg||''; }

    async function login(username, password){
        const res = await fetch(API('/organisator/login'), {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({username, password}), credentials:'include'
        });
        if(!res.ok) throw new Error('Login failed');
        return await res.json();
    }

    async function signup(name, username, password){
        const res = await fetch(API('/organisator/signup'), {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({name, username, password})
        });
        if(!res.ok) throw new Error('Signup failed');
        return await res.json();
    }

    async function me(){
        const res = await fetch(API('/organisator/me'), {credentials:'include'});
        if(!res.ok) throw 0;
        return await res.json();
    }

    async function loadEvents(){
        const res = await fetch(API('/organisator/events'), {credentials:'include'});
        if(!res.ok) throw new Error('Events failed');
        return await res.json();
    }

    async function createEvent(payload){
        const res = await fetch(API('/organisator/events'), {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload), credentials:'include'
        });
        if(!res.ok) throw new Error('Create failed');
        return await res.json();
    }

    async function delEvent(id){
        const res = await fetch(API('/organisator/events/'+id), {method:'DELETE', credentials:'include'});
        if(!res.ok) throw new Error('Delete failed');
    }

    function renderEvents(items){
        const tb = $('#list'); tb.innerHTML='';
        for(const e of items){
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${e.id}</td><td>${e.title}</td><td>${e.start_date||''}</td><td>${e.end_date||''}</td>
                        <td><button data-id="${e.id}" class="del">Delete</button></td>`;
            tb.appendChild(tr);
        }
        tb.onclick = async (ev)=>{
            const b = ev.target.closest('.del'); if(!b) return;
            if(!confirm('Delete event #'+b.dataset.id+'?')) return;
            try{ await delEvent(b.dataset.id); await initAfterAuth(); }catch(e){ alert(e.message); }
        };
    }

    // Forms
    $('#loginForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        try{
            const data = await login($('#username').value, $('#password').value);
            show('Hello, '+data?.organisator?.username);
            await initAfterAuth();
        }catch(err){ show(err.message); }
    });

    $('#signupForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        try{
            const data = await signup($('#s_name').value, $('#s_username').value, $('#s_password').value);
            show('Created user '+data.username+'. Now login above.');
        }catch(err){ show(err.message); }
    });

    $('#logout').addEventListener('click', async ()=>{
        await fetch('/organisator/logout', {method:'POST', credentials:'include'});
        location.reload();
    });

    $('#createEvent').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const payload = {
            title: $('#e_title').value.trim(),
            preview: $('#e_preview').value.trim() || null,
            start_date: $('#e_start').value ? new Date($('#e_start').value).toISOString() : null,
            end_date: $('#e_end').value ? new Date($('#e_end').value).toISOString() : null,
            dj_id: $('#e_dj').value ? Number($('#e_dj').value) : null,
        };
        try{
            await createEvent(payload);
            $('#e_title').value=''; $('#e_preview').value=''; $('#e_start').value=''; $('#e_end').value=''; $('#e_dj').value='';
            await initAfterAuth();
        }catch(err){ alert(err.message); }
    });

    async function initAfterAuth(){
        try{
            const u = await me();
            $('#auth').style.display='none';
            $('#events').style.display='block';
            const list = await loadEvents();
            renderEvents(list);
        }catch{
            $('#auth').style.display='block';
            $('#events').style.display='none';
        }
    }
    initAfterAuth();
</script>
</body>
</html>
