<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Next Track</title>

  <style>
    :root{
      --bg:#0b0b0f;
      --panel:#12121a;
      --panel2:#171725;
      --text:#f2f2f6;
      --muted:#a8a8b6;
      --line:rgba(255,255,255,.08);
      --danger:#ff4d6d;
      --ok:#35d07f;
      --warn:#ffd166;
      --radius:16px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 600px at 50% -200px, rgba(111,66,193,.25), transparent 60%),
                  radial-gradient(900px 500px at 90% 0, rgba(0,212,255,.14), transparent 60%),
                  var(--bg);
    }

    .wrap{
      width: min(980px, calc(100vw - 24px));
      margin: 16px auto 40px;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: rgba(11,11,15,.66);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px 14px;
    }

    .topline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .titleBlock{
      min-width: 0;
    }

    .clubTitle{
      font-size: 12px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--muted);
      margin: 0 0 4px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .eventTitle{
      font-size: 18px;
      font-weight: 800;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .statusPill{
      padding: 7px 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 14px;
    }

    .card{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border-radius: var(--radius);
      overflow: hidden;
    }

    .cardHead{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
    }

    .cardHead h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.02em;
      color: var(--text);
    }

    .cardBody{
      padding: 14px;
    }

    .muted{ color: var(--muted); }

    /* Fatal error banner */
    .fatal{
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      max-width: min(720px, calc(100vw - 32px));
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(20,20,20,.92);
      color: #fff;
      font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      z-index: 9999;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.12);
      white-space: pre-wrap;
    }
    .fatal.hidden{ display:none; }

    /* Now playing block */
    .np{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .npTitle{
      font-weight: 800;
      font-size: 16px;
      margin: 0;
    }
    .npMeta{
      color: var(--muted);
      margin: 0;
    }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      appearance: none;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
    }
    button:hover{ background: rgba(255,255,255,.10); }
    button:disabled{
      opacity: .55;
      cursor: not-allowed;
    }

    .tiny{ font-size: 12px; }
  </style>
</head>

<body>
  <!-- Error banner -->
  <div id="fatalError" class="fatal hidden" role="alert" aria-live="assertive"></div>

  <div class="wrap">
    <header>
      <div class="topline">
        <div class="titleBlock">
          <p id="clubName" class="clubTitle">Loading…</p>
          <h1 id="eventName" class="eventTitle">Loading…</h1>
        </div>
        <div id="topStatus" class="statusPill">Connecting…</div>
      </div>
    </header>

    <main class="grid">
      <section class="card">
        <div class="cardHead">
          <h2>Now Playing</h2>
          <span id="npStatus" class="statusPill tiny">—</span>
        </div>
        <div class="cardBody">
          <!-- ВАЖЛИВО: тут більше НЕМА дефолтного "Now Playing" треку.
               Поки дані не прийшли — буде "Loading…", або пусто, або помилка. -->
          <div id="nowPlaying" class="np">
            <p class="muted" id="npPlaceholder">Loading…</p>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="cardHead">
          <h2>Debug</h2>
          <span class="statusPill tiny">client</span>
        </div>
        <div class="cardBody">
          <div class="btnRow">
            <button id="btnRefresh">Refresh event</button>
            <button id="btnCopySlug">Copy slug</button>
          </div>
          <p class="muted tiny" id="debugLine"></p>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ----------------------------
    // State
    // ----------------------------
    const state = {
      event: null,
      votingOpen: false,
      voteClosesAt: 0,
      trackEndsAt: 0
    };

    // ----------------------------
    // UI helpers
    // ----------------------------
    function showFatalError(message, details) {
      const el = document.getElementById('fatalError');
      if (!el) return;
      const extra = details ? `\n${details}` : '';
      el.textContent = `${message}${extra}`;
      el.classList.remove('hidden');
    }

    function clearFatalError() {
      const el = document.getElementById('fatalError');
      if (!el) return;
      el.textContent = '';
      el.classList.add('hidden');
    }

    function setTopStatus(text) {
      const el = document.getElementById('topStatus');
      if (el) el.textContent = text;
    }

    function setNowPlayingStatus(text) {
      const el = document.getElementById('npStatus');
      if (el) el.textContent = text;
    }

    // Безпечний getter
    function pickFirst(obj, paths, fallback = '') {
      for (const p of paths) {
        const val = p.split('.').reduce((acc, key) => (acc && acc[key] != null ? acc[key] : undefined), obj);
        if (typeof val === 'string' && val.trim()) return val.trim();
        if (typeof val === 'number') return String(val);
      }
      return fallback;
    }

    // ----------------------------
    // EVENT_SLUG parsing
    // ----------------------------
    function parseEventSlug() {
      const url = new URL(window.location.href);

      const qpEvent = (url.searchParams.get('event') || '').trim();
      if (qpEvent) return qpEvent;

      const tgStart = (url.searchParams.get('tgWebAppStartParam') || '').trim();
      if (tgStart) {
        const m = tgStart.match(/^event_(.+)$/i);
        return (m ? m[1] : tgStart).trim();
      }

      const startapp = (url.searchParams.get('startapp') || '').trim();
      if (startapp) return startapp;

      const parts = url.pathname.split('/').filter(Boolean);
      const idx = parts.findIndex(p => p.toLowerCase() === 'event');
      if (idx !== -1 && parts[idx + 1]) return parts[idx + 1].trim();

      return '';
    }

    const EVENT_SLUG = parseEventSlug();

    // ----------------------------
    // HTTP + JSON
    // ----------------------------
    class HttpError extends Error {
      constructor(message, { status = 0, bodyText = '', url = '', isNetworkError = false, isJson = false } = {}) {
        super(message);
        this.name = 'HttpError';
        this.status = status;
        this.bodyText = bodyText;
        this.url = url;
        this.isNetworkError = isNetworkError;
        this.isJson = isJson;
      }
    }

    async function getJSON(url, opts = {}) {
      const controller = new AbortController();
      const timeoutMs = opts.timeoutMs ?? 15000;
      const t = setTimeout(() => controller.abort(), timeoutMs);

      try {
        const res = await fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            ...(opts.headers || {})
          },
          credentials: opts.credentials ?? 'same-origin',
          signal: controller.signal
        });

        const contentType = (res.headers.get('content-type') || '').toLowerCase();
        const isJson = contentType.includes('application/json');

        let bodyText = '';
        try { bodyText = await res.text(); } catch (_) { bodyText = ''; }

        if (!res.ok) {
          throw new HttpError(`HTTP ${res.status}`, {
            status: res.status,
            bodyText,
            url: res.url,
            isNetworkError: false,
            isJson
          });
        }

        if (!bodyText) return null;

        try {
          return JSON.parse(bodyText);
        } catch (_) {
          throw new HttpError('Invalid JSON response', {
            status: res.status,
            bodyText,
            url: res.url,
            isNetworkError: false,
            isJson: true
          });
        }

      } catch (e) {
        if (e && e.name === 'AbortError') {
          throw new HttpError('Request timeout', { status: 0, isNetworkError: true, url });
        }
        if (e instanceof HttpError) throw e;
        throw new HttpError(e?.message || 'Network error', { status: 0, isNetworkError: true, url });
      } finally {
        clearTimeout(t);
      }
    }

    // ----------------------------
    // Rendering
    // ----------------------------
    function renderEventHeader() {
      const clubEl = document.getElementById('clubName');
      const eventEl = document.getElementById('eventName');

      const data = state.event;

      // Підтримка як "плоских" полів, так і вкладених
      const clubName = pickFirst(data, [
        'club.name',
        'club.title',
        'club_name',
        'club_title',
        'clubName',
        'clubTitle'
      ], EVENT_SLUG ? EVENT_SLUG.toUpperCase() : 'Club');

      const eventTitle = pickFirst(data, [
        'title',
        'name',
        'event_title',
        'eventName',
        'event.name',
        'event.title'
      ], 'Event');

      if (clubEl) clubEl.textContent = clubName;
      if (eventEl) eventEl.textContent = eventTitle;

      // Статус зверху
      const st = data?.state || {};
      const votingOpen = (st.voting_open === "1" || st.voting_open === 1 || st.voting_open === true);
      setTopStatus(votingOpen ? 'Voting open' : 'Voting closed');
    }

    function renderNowPlaying() {
      const box = document.getElementById('nowPlaying');
      const placeholder = document.getElementById('npPlaceholder');
      if (!box) return;

      // очищаємо box, але без "дефолтної Now Playing"
      box.innerHTML = '';

      const data = state.event;

      // Підтримка різних структур (підлаштовано)
      const nowTitle = pickFirst(data, [
        'now_playing.title',
        'now_playing.name',
        'current_track.title',
        'current_track.name',
        'track.title',
        'track.name'
      ], '');

      const nowArtist = pickFirst(data, [
        'now_playing.artist',
        'current_track.artist',
        'track.artist'
      ], '');

      // Якщо даних нема — не вигадуємо, просто показуємо людське повідомлення
      if (!nowTitle && !nowArtist) {
        const p = document.createElement('p');
        p.className = 'muted';
        p.textContent = 'Nothing is playing right now.';
        box.appendChild(p);
        setNowPlayingStatus('—');
        return;
      }

      const h = document.createElement('p');
      h.className = 'npTitle';
      h.textContent = nowTitle || 'Unknown track';

      const m = document.createElement('p');
      m.className = 'npMeta';
      m.textContent = nowArtist ? nowArtist : 'Unknown artist';

      box.appendChild(h);
      box.appendChild(m);

      setNowPlayingStatus('LIVE');
    }

    function updateDebugLine() {
      const el = document.getElementById('debugLine');
      if (!el) return;
      const url = `/api/v1/events/${encodeURIComponent(EVENT_SLUG || '')}`;
      el.textContent = `slug="${EVENT_SLUG || '(empty)'}"  endpoint="${url}"`;
    }

    // ----------------------------
    // Main fetch
    // ----------------------------
    async function refreshEvent() {
      clearFatalError();

      if (!EVENT_SLUG) {
        setTopStatus('Missing slug');
        showFatalError('Missing event slug.', 'Use ?event=kaif or open /event/kaif');
        return;
      }

      try {
        setTopStatus('Loading…');
        setNowPlayingStatus('…');

        const url = `/api/v1/events/${encodeURIComponent(EVENT_SLUG)}`;
        const data = await getJSON(url);

        // якщо бек віддає {event: {...}}, підхопимо
        state.event = (data && data.event) ? data.event : data;

        renderEventHeader();
        renderNowPlaying();

        // таймери (залишив твою логіку)
        const st = state.event?.state || {};
        state.votingOpen = (st.voting_open === "1" || st.voting_open === 1 || st.voting_open === true);
        state.voteClosesAt = Number(st.vote_closes_at || 0);
        state.trackEndsAt = Number(st.track_ends_at || 0);

        setTopStatus(state.votingOpen ? 'Voting open' : 'Voting closed');

      } catch (err) {
        const status = err?.status ?? 0;

        if (status === 404) {
          location.replace('/404');
          return;
        }

        if (status === 401 || status === 403) {
          setTopStatus('Unauthorized');
          showFatalError('Not authorized');
          return;
        }

        if (status === 0 || status === 502 || status === 504) {
          setTopStatus('Unavailable');
          showFatalError('Service temporarily unavailable. Try again.');
          return;
        }

        setTopStatus('Error');
        showFatalError('Something went wrong.', status ? `HTTP ${status}` : '');
        console.error('refreshEvent error:', err);
      }
    }

    // ----------------------------
    // Wire up
    // ----------------------------
    document.getElementById('btnRefresh')?.addEventListener('click', refreshEvent);
    document.getElementById('btnCopySlug')?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(EVENT_SLUG || '');
        setTopStatus('Copied');
        setTimeout(() => setTopStatus(state.votingOpen ? 'Voting open' : 'Ready'), 800);
      } catch (_) {
        showFatalError('Can’t copy to clipboard.');
      }
    });

    // init
    updateDebugLine();
    refreshEvent();
  </script>
</body>
</html>
